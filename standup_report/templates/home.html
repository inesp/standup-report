{% extends "base.html" %}


{% block content %}
<!-- Configuration Overview -->
<div class="info-box-yellow mb-6">

  <div class="grid md:grid-cols-2 gap-6">
    <div>
      <h4 class="text-yellow-800 font-medium mb-2">Required Settings in <code class="code-yellow">.env</code></h4>
      <p class="text-sm text-yellow-700 mb-2">Look at <code class="code-yellow">.env.example</code> for a complete list.</p>
      <div class="bg-white rounded-lg shadow-sm border border-yellow-400 p-3">
        <ul class="text-sm text-yellow-700 space-y-1 mt-1 ml-6 list-disc">
          <li><code class="code-yellow">GH_API_TOKEN</code> - Your GitHub personal access token</li>
          <li><code class="code-yellow">GH_LOGIN</code> - The GitHub username who can use the token</li>
          <li><code class="code-yellow">GH_USERNAME</code> - Your GitHub username, the author of PRs</li>
          <li><code class="code-yellow">LINEAR_TOKEN</code> - Your Linear personal API key</li>
          <li><code class="code-yellow">LINEAR_EMAIL</code> - Your Linear email, the author/assignee/... of issues</li>
        </ul>
      </div>
    </div>

    <div>
      <h4 class="text-yellow-800 font-medium mb-2">Optional Config in <code class="code-yellow">{{ settings.CONFIG_FILE_NAME }}</code></h4>
      <p class="text-sm text-yellow-700 mb-2">Look at <code class="code-yellow">{{ settings.CONFIG_FILE_NAME }}.example</code> for a complete list.</p>
      <div class="bg-white rounded-lg shadow-sm border border-yellow-400 p-3">
        <ul class="text-sm text-yellow-700 space-y-1 mt-1 ml-6 list-disc">
          <li><code class="code-yellow">ignored_repos</code> - List of repos to exclude from the report</li>
        </ul>
      </div>
    </div>
  </div>
</div>

<div class="grid md:grid-cols-2 gap-6">
  <!-- GitHub Connection Status -->
  {% set gh_ok = gh_response and not gh_exc %}
  <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
    <div class="flex items-center mb-4">
      <div class="w-3 h-3 {% if gh_ok %}bg-green-500{% else %}bg-red-500{% endif %} rounded-full mr-3"></div>
      <h3 class="text-lg font-semibold text-gray-900">GitHub Connection</h3>
      <span class="ml-auto {% if gh_ok %}bg-green-100 text-green-800{% else %}bg-red-100 text-red-800{% endif %} text-xs font-medium px-2 py-1 rounded">{% if gh_ok %}Connected{% else %}Error{% endif %}</span>
    </div>

    {% if gh_ok %}
      <div class="text-sm text-gray-600 mb-2">Successfully received GH response:</div>
      <code class="bg-gray-100 text-gray-800 px-2 py-1 rounded text-sm">{{ gh_response }}</code>
    {% else %}
      <div class="bg-red-50 border border-red-200 rounded p-3">
        <p class="text-sm text-red-800 mb-2">GQL query <code class="code-red ">{{ gh_query }}</code>.</p>
        {% if gh_exc %}
          <code class="code-red text-red-800 rounded text-xs block mb-2">{{ gh_exc.user_error_desc() }}</code>
        {% endif %}
      </div>
    {% endif %}
  </div>

  <!-- Linear Connection Status -->
  {% set linear_ok = linear_response and not linear_exc %}
  <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
    <div class="flex items-center mb-4">
      <div class="w-3 h-3 {% if gh_ok %}bg-green-500{% else %}bg-red-500{% endif %} rounded-full mr-3"></div>
      <h3 class="text-lg font-semibold text-gray-900">Linear Connection</h3>
      <span class="ml-auto {% if gh_ok %}bg-green-100 text-green-800{% else %}bg-red-100 text-red-800{% endif %} text-xs font-medium px-2 py-1 rounded">{% if linear_ok %}Connected{% else %}Error{% endif %}</span>
    </div>

    {% if linear_ok %}
      <div class="text-sm text-gray-600 mb-2">Successfully received Linear response:</div>
      <code class="bg-gray-100 text-gray-800 px-2 py-1 rounded text-sm">{{ linear_response }}</code>
    {% else %}
      <div class="bg-red-50 border border-red-200 rounded p-3">
        <p class="text-sm text-red-800 mb-2">Linear query <code class="code-red ">{{ linear_query }}</code>.</p>
        {% if linear_exc %}
          <code class="code-red text-red-800 rounded text-xs block mb-2">{{ linear_exc.user_error_desc() }}</code>
        {% endif %}
      </div>
    {% endif %}
  </div>

  <!-- Google Calendar Connection Status (Optional) -->
  <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
    <div class="flex items-center mb-4">
      <div class="w-3 h-3 {% if google_auth_status.is_authenticated %}bg-green-500{% elif google_auth_status.needs_auth %}bg-yellow-500{% else %}bg-gray-400{% endif %} rounded-full mr-3"></div>
      <h3 class="text-lg font-semibold text-gray-900">Google Calendar</h3>
      <span class="ml-2 bg-gray-100 text-gray-600 text-xs font-medium px-2 py-1 rounded">Optional</span>
      <span class="ml-auto {% if google_auth_status.is_authenticated %}bg-green-100 text-green-800{% elif google_auth_status.needs_auth %}bg-yellow-100 text-yellow-800{% else %}bg-gray-100 text-gray-600{% endif %} text-xs font-medium px-2 py-1 rounded">
        {% if google_auth_status.is_authenticated %}Connected{% elif google_auth_status.needs_auth %}Needs Auth{% else %}Not Configured{% endif %}
      </span>
    </div>

    {% if google_auth_status.is_authenticated %}
      {% if google_calendars and not google_exc %}
        <div class="text-sm text-gray-600 mb-2">Successfully received Google Calendar response.</div>
        <code class="bg-gray-100 text-gray-800 px-2 py-1 rounded text-sm">Found calendars: {{ google_calendars }}</code>
      {% else %}
        <div class="bg-red-50 border border-red-200 rounded p-3">
          <p class="text-sm text-red-800 mb-2">REST endpoint <code class="code-red">{{ google_endpoint }}</code>.</p>
          {% if google_exc %}
            <code class="code-red text-red-800 rounded text-xs block mb-2">{{ google_exc.user_error_desc() }}</code>
          {% endif %}
        </div>
      {% endif %}
    {% elif google_auth_status.needs_auth %}
      <div class="text-sm text-gray-600 mb-3">{{ google_auth_status.message }}</div>
      <a href="{{ url_for('google_auth.start_auth') }}" class="text-blue-600 hover:text-blue-800 text-sm">Connect Google Calendar â†’</a>
    {% elif google_auth_status.missing_credentials %}
      <div class="text-sm text-gray-600 mb-3">{{ google_auth_status.message }}</div>
      <p class="text-sm text-gray-500">See <a href="https://github.com/inesp/standup-report#google-calendar" class="text-blue-600 hover:underline">README</a> for setup instructions.</p>
    {% endif %}
  </div>

  <!-- DuckDB Status -->
  <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
    {% set duck_ok = duckdb_health and duckdb_health.status == 'healthy' %}
    <div class="flex items-center mb-4">
      <div class="w-3 h-3 {% if duck_ok %}bg-green-500{% else %}bg-red-500{% endif %} rounded-full mr-3"></div>
      <h3 class="text-lg font-semibold text-gray-900">DuckDB Storage</h3>
      <span class="ml-auto {% if duck_ok %}bg-green-100 text-green-800{% else %}bg-red-100 text-red-800{% endif %} text-xs font-medium px-2 py-1 rounded">
        {% if duck_ok %}Healthy{% else %}Error{% endif %}
      </span>
    </div>

      <div class="space-y-2">
        <div>
          <span class="text-sm text-gray-600">Database file:</span>
          <code class="bg-gray-100 text-gray-800 px-2 py-1 rounded text-sm ml-2">{{ duckdb_health.database_file }}</code>
        </div>

        {% if duck_ok %}
          {% if duckdb_health.row_counts %}
          <div>
            <span class="text-sm text-gray-600">Data:</span>
            {% for table, count in duckdb_health.row_counts.items() %}
              <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded text-xs ml-2">{{ count }} {{ table }}</span>
            {% endfor %}
          </div>
          {% endif %}

          <div>
            <span class="text-sm text-gray-600">Tables:</span>
            <code class="bg-gray-100 text-gray-800 px-2 py-1 rounded text-xs ml-2">{{ duckdb_health.tables|join(', ') }}</code>
          </div>

        {% else %}
          <div class="bg-red-50 border border-red-200 rounded p-3">
            <p class="text-sm text-red-800 mb-2">DuckDB Connection Failed</p>
            {% if duckdb_health and duckdb_health.error_msg %}
              <code class="bg-red-100 text-red-800 px-2 py-1 rounded text-xs block">{{ duckdb_health.error_msg }}</code>
            {% endif %}
          </div>
        {% endif %}

        <div>
          <a href="/recreate_db" class="text-red-600 hover:text-red-800 text-sm">
            <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1-1H8a1 1 0 00-1 1v3M4 7h16"></path>
            </svg>
            Recreate DB
          </a>
        </div>
      </div>
  </div>
</div>

<div class="mt-6">
  <!-- Configuration -->
  <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
    <div class="flex items-center mb-4">
      {% set config_ok = settings and not settings_error %}
      <div class="w-3 h-3 {{ 'bg-green-500' if config_ok else 'bg-red-500' }} rounded-full mr-3"></div>
      <h3 class="text-lg font-semibold text-gray-900">Configuration</h3>
      <span class="ml-auto {{ 'bg-green-100 text-green-800' if config_ok else 'bg-red-100 text-red-800' }} text-xs font-medium px-2 py-1 rounded">
        {{ 'Loaded' if config_ok else 'Error' }}
      </span>
    </div>

    {% if settings_error %}
      <div class="info-box-red">
        <p class="text-sm text-red-800 mb-2 font-medium">Configuration Error</p>
        <code class="bg-red-100 text-red-800 px-2 py-1 rounded text-xs block mb-3">{{ settings_error }}</code>
      </div>
    {% elif settings %}
      <div class="space-y-3">
        {% for key, field in settings.as_dict.items() %}
          <div class="flex justify-between py-2 border-b border-gray-100">
            <span class="text-sm font-medium text-gray-700">{{ key }}:</span>
            <code class="text-sm text-gray-600 bg-gray-50 px-2 py-1 rounded">
              {% if key == 'GH_TOKEN' %}
                {{ '***' + field[-4:] if field|length > 4 else '***' }}
              {% else %}
                {{ field }}
              {% endif %}
            </code>
          </div>
        {% endfor %}
      </div>
    {% endif %}
  </div>
</div>
{% endblock %}
